<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>游戏商城管理后台</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@latest"></script>
  <style>
    :root {
      --primary: #ff2a6d;
      --secondary: #05d9e8;
      --dark: #0c0e27;
      --darker: #05071a;
      --light: #d1f7ff;
      --card-bg: rgba(16, 18, 45, 0.7);
      --card-border: rgba(5, 217, 232, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
      color: var(--light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 15px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--card-border);
    }
    
    .logo {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .admin-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .admin-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--dark);
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-box {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      text-align: center;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .stat-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      margin: 10px 0;
      color: var(--secondary);
    }
    
    .stat-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .tab-container {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--card-border);
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .tab-buttons {
      display: flex;
      background: rgba(0, 0, 0, 0.2);
      overflow-x: auto;
    }
    
    .tab-btn {
      background: none;
      border: none;
      color: var(--light);
      padding: 15px 20px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.3s;
      position: relative;
    }
    
    .tab-btn:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .tab-btn.active {
      background: rgba(255, 255, 255, 0.1);
      color: var(--secondary);
    }
    
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--secondary);
    }
    
    .tab-content {
      padding: 20px;
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tab-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: var(--secondary);
      padding-bottom: 10px;
      border-bottom: 1px solid var(--card-border);
    }
    
    .list-container {
      max-height: 500px;
      overflow-y: auto;
      margin-top: 15px;
    }
    
    .message-item, .product-item, .user-item, .order-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 3px solid var(--primary);
      transition: all 0.3s;
    }
    
    .message-item:hover, .product-item:hover, .user-item:hover, .order-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    
    .message-item.unread {
      border-left-color: var(--secondary);
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .message-user {
      font-weight: bold;
    }
    
    .message-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .message-content {
      margin-bottom: 10px;
    }
    
    .message-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .reply-area {
      margin-top: 10px;
      display: none;
    }
    
    .reply-area.active {
      display: block;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--light);
      box-sizing: border-box;
      font-size: 14px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(5, 217, 232, 0.2);
    }
    
    button {
      background: var(--primary);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(255, 42, 109, 0.3);
    }
    
    button.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--light);
    }
    
    button.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    button.success {
      background: var(--secondary);
      color: var(--dark);
    }
    
    button.danger {
      background: #ff4757;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .product-list {
      margin-top: 20px;
    }
    
    .product-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-pending {
      background: rgba(255, 165, 0, 0.2);
      color: #ffa500;
    }
    
    .status-paid {
      background: rgba(0, 255, 0, 0.2);
      color: #00ff00;
    }
    
    .status-completed {
      background: rgba(5, 217, 232, 0.2);
      color: var(--secondary);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .order-info {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .tab-buttons {
        flex-wrap: wrap;
      }
    }
    
    @media (max-width: 480px) {
      .stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">游戏商城管理后台</div>
      <div class="admin-info">
        <div class="admin-avatar">A</div>
        <div>管理员</div>
      </div>
    </div>

    <!-- 数据统计 -->
    <div class="stats">
      <div class="stat-box">
        <div class="stat-label">总访问量</div>
        <div class="stat-value" id="total-visits">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">注册用户数</div>
        <div class="stat-value" id="total-users">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">未读消息</div>
        <div class="stat-value" id="unread-messages">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">商品总数</div>
        <div class="stat-value" id="total-products">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">订单总数</div>
        <div class="stat-value" id="total-orders">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">今日访问</div>
        <div class="stat-value" id="today-visits">0</div>
      </div>
    </div>

    <!-- 功能标签页 -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-btn active" onclick="showTab('messages')">用户消息</button>
        <button class="tab-btn" onclick="showTab('products')">商品管理</button>
        <button class="tab-btn" onclick="showTab('users')">用户列表</button>
        <button class="tab-btn" onclick="showTab('orders')">订单管理</button>
        <button class="tab-btn" onclick="showTab('analytics')">数据分析</button>
      </div>

      <!-- 消息管理 -->
      <div class="tab-content active" id="messages">
        <div class="tab-title">用户消息列表</div>
        <div class="list-container" id="message-list">
          <!-- 消息列表将通过JS动态加载 -->
        </div>
      </div>

      <!-- 商品管理 -->
      <div class="tab-content" id="products">
        <div class="tab-title">商品管理</div>
        <div class="form-grid">
          <div class="form-group">
            <label>游戏类型</label>
            <select id="product-game">
              <option value="王者">王者荣耀</option>
              <option value="和平">和平精英</option>
              <option value="火影">火影忍者</option>
            </select>
          </div>
          <div class="form-group">
            <label>商品名称</label>
            <input type="text" id="product-name" placeholder="输入商品名称" required>
          </div>
          <div class="form-group">
            <label>价格</label>
            <input type="number" id="product-price" placeholder="输入价格" step="0.01" required>
          </div>
          <div class="form-group">
            <label>商品图片URL</label>
            <input type="text" id="product-img" placeholder="输入图片链接" required>
          </div>
          <div class="form-group">
            <label>收款码URL（付费商品）</label>
            <input type="text" id="product-paycode" placeholder="输入收款码链接">
          </div>
          <div class="form-group">
            <label>是否免费</label>
            <select id="product-is-free">
              <option value="false">否</option>
              <option value="true">是</option>
            </select>
          </div>
        </div>
        <button onclick="saveProduct()">保存商品</button>
        
        <div class="product-list">
          <div class="tab-title" style="margin-top: 30px;">商品列表</div>
          <div class="list-container" id="products-list">
            <!-- 商品列表将通过JS动态加载 -->
          </div>
        </div>
      </div>

      <!-- 用户列表 -->
      <div class="tab-content" id="users">
        <div class="tab-title">用户列表</div>
        <div class="list-container" id="users-list">
          <!-- 用户列表将通过JS动态加载 -->
        </div>
      </div>

      <!-- 订单管理 -->
      <div class="tab-content" id="orders">
        <div class="tab-title">订单列表</div>
        <div class="list-container" id="orders-list">
          <!-- 订单列表将通过JS动态加载 -->
        </div>
      </div>

      <!-- 数据分析 -->
      <div class="tab-content" id="analytics">
        <div class="tab-title">数据分析</div>
        <div class="form-grid">
          <div class="form-group">
            <label>选择时间段</label>
            <select id="analytics-period">
              <option value="7">最近7天</option>
              <option value="30">最近30天</option>
              <option value="90">最近90天</option>
            </select>
          </div>
          <div class="form-group">
            <label>统计类型</label>
            <select id="analytics-type">
              <option value="visits">访问量</option>
              <option value="messages">消息数</option>
              <option value="orders">订单数</option>
            </select>
          </div>
        </div>
        <button onclick="loadAnalytics()">生成报告</button>
        <div id="analytics-results" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <script>
    // 初始化Supabase - 使用您提供的密钥
    const supabase = supabase.createClient(
      'https://derdyfhnwuxuofqkumlf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlcmR5Zmhud3V4dW9mcWt1bWxmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzAzMjEwNSwiZXhwIjoyMDc4NjA4MTA1fQ.h6s-3Wj23iExMPxJkTht7cjs_r2eZ8cOd-lfucTtuno'
    );

    // 切换标签页
    function showTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');

      // 加载对应内容
      if (tabId === 'messages') loadMessages();
      if (tabId === 'products') loadProducts();
      if (tabId === 'users') loadUsers();
      if (tabId === 'orders') loadOrders();
      if (tabId === 'analytics') loadAnalytics();
    }

    // 加载统计数据
    async function loadStats() {
      try {
        // 总访问量
        const { count: visitsCount } = await supabase
          .from('visits')
          .select('*', { count: 'exact', head: true });
        document.getElementById('total-visits').textContent = visitsCount || 0;

        // 注册用户数
        const { count: usersCount } = await supabase
          .from('users')
          .select('*', { count: 'exact', head: true });
        document.getElementById('total-users').textContent = usersCount || 0;

        // 未读消息数
        const { count: unreadCount } = await supabase
          .from('messages')
          .select('*', { count: 'exact', head: true })
          .eq('is_read', false);
        document.getElementById('unread-messages').textContent = unreadCount || 0;

        // 商品总数
        const { count: productsCount } = await supabase
          .from('products')
          .select('*', { count: 'exact', head: true });
        document.getElementById('total-products').textContent = productsCount || 0;

        // 订单总数
        const { count: ordersCount } = await supabase
          .from('orders')
          .select('*', { count: 'exact', head: true });
        document.getElementById('total-orders').textContent = ordersCount || 0;

        // 今日访问量
        const today = new Date().toISOString().split('T')[0];
        const { count: todayVisitsCount } = await supabase
          .from('visits')
          .select('*', { count: 'exact', head: true })
          .gte('timestamp', today);
        document.getElementById('today-visits').textContent = todayVisitsCount || 0;
      } catch (error) {
        console.error('加载统计数据失败:', error);
      }
    }

    // 加载用户消息
    async function loadMessages() {
      try {
        const { data, error } = await supabase
          .from('messages')
          .select('*')
          .order('create_time', { ascending: false });
        
        const messageList = document.getElementById('message-list');
        
        if (error || !data || data.length === 0) {
          messageList.innerHTML = '<div class="empty-state">暂无消息</div>';
          return;
        }
        
        messageList.innerHTML = data.map(msg => `
          <div class="message-item ${msg.is_read ? '' : 'unread'}">
            <div class="message-header">
              <div class="message-user">用户ID: ${msg.user_id}</div>
              <div class="message-time">${new Date(msg.create_time).toLocaleString()}</div>
            </div>
            <div class="message-content">${msg.content}</div>
            <div class="message-actions">
              <button class="secondary" onclick="toggleReply(${msg.id})">回复</button>
              ${!msg.is_read ? `<button class="success" onclick="markAsRead(${msg.id})">标记为已读</button>` : ''}
            </div>
            <div class="reply-area" id="reply-${msg.id}">
              <textarea id="reply-content-${msg.id}" placeholder="输入回复内容" rows="3"></textarea>
              <button onclick="replyMessage(${msg.id}, '${msg.user_id}')">发送回复</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('加载消息失败:', error);
        document.getElementById('message-list').innerHTML = '<div class="empty-state">加载消息失败</div>';
      }
    }

    // 显示/隐藏回复区域
    function toggleReply(messageId) {
      const replyArea = document.getElementById(`reply-${messageId}`);
      replyArea.classList.toggle('active');
    }

    // 回复消息
    async function replyMessage(messageId, userId) {
      const replyContent = document.getElementById(`reply-content-${messageId}`).value;
      if (!replyContent.trim()) {
        alert('请输入回复内容');
        return;
      }

      try {
        // 插入管理员回复到消息表
        await supabase.from('messages').insert([{
          user_id: userId,
          content: `管理员回复: ${replyContent}`,
          is_admin: true,
          is_read: true
        }]);
        
        // 标记原消息为已读
        await supabase.from('messages').update({ is_read: true }).eq('id', messageId);
        
        alert('回复成功');
        document.getElementById(`reply-content-${messageId}`).value = '';
        document.getElementById(`reply-${messageId}`).classList.remove('active');
        
        loadMessages();
        loadStats();
      } catch (error) {
        console.error('回复消息失败:', error);
        alert('回复失败，请重试');
      }
    }

    // 标记消息为已读
    async function markAsRead(messageId) {
      try {
        await supabase.from('messages').update({ is_read: true }).eq('id', messageId);
        loadMessages();
        loadStats();
      } catch (error) {
        console.error('标记消息已读失败:', error);
        alert('操作失败，请重试');
      }
    }

    // 加载商品列表
    async function loadProducts() {
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .order('id', { ascending: true });
        
        const productsList = document.getElementById('products-list');
        
        if (error || !data || data.length === 0) {
          productsList.innerHTML = '<div class="empty-state">暂无商品</div>';
          return;
        }
        
        productsList.innerHTML = data.map(product => `
          <div class="product-item">
            <div><strong>${product.game}</strong> - ${product.name}</div>
            <div class="order-info">价格: ${product.is_free ? '免费' : `${product.price}元`}</div>
            <div class="product-actions">
              <button class="danger" onclick="deleteProduct(${product.id})">删除</button>
              <button class="secondary" onclick="editProduct(${product.id})">编辑</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('加载商品失败:', error);
        document.getElementById('products-list').innerHTML = '<div class="empty-state">加载商品失败</div>';
      }
    }

    // 保存商品
    async function saveProduct() {
      const game = document.getElementById('product-game').value;
      const name = document.getElementById('product-name').value.trim();
      const price = document.getElementById('product-price').value;
      const imageUrl = document.getElementById('product-img').value.trim();
      const payCodeUrl = document.getElementById('product-paycode').value.trim();
      const isFree = document.getElementById('product-is-free').value === 'true';

      // 表单验证
      if (!name || !imageUrl) {
        alert('请填写必填项（名称、图片）');
        return;
      }
      
      if (!isFree && (!price || price <= 0)) {
        alert('付费商品需填写有效价格');
        return;
      }

      try {
        await supabase.from('products').insert([{
          game, 
          name, 
          price: isFree ? 0 : price,
          image_url: imageUrl,
          pay_code_url: payCodeUrl || null,
          is_free: isFree
        }]);
        
        alert('商品保存成功');
        // 清空表单
        document.getElementById('product-name').value = '';
        document.getElementById('product-price').value = '';
        document.getElementById('product-img').value = '';
        document.getElementById('product-paycode').value = '';
        
        loadProducts();
        loadStats();
      } catch (error) {
        console.error('保存商品失败:', error);
        alert('保存商品失败，请重试');
      }
    }

    // 删除商品
    async function deleteProduct(productId) {
      if (!confirm('确定要删除该商品吗？此操作不可撤销。')) return;
      
      try {
        await supabase.from('products').delete().eq('id', productId);
        loadProducts();
        loadStats();
      } catch (error) {
        console.error('删除商品失败:', error);
        alert('删除商品失败，请重试');
      }
    }

    // 加载用户列表
    async function loadUsers() {
      try {
        const { data, error } = await supabase
          .from('users')
          .select('*')
          .order('create_time', { ascending: false });
        
        const usersList = document.getElementById('users-list');
        
        if (error || !data || data.length === 0) {
          usersList.innerHTML = '<div class="empty-state">暂无用户</div>';
          return;
        }
        
        usersList.innerHTML = data.map(user => `
          <div class="user-item">
            <div><strong>${user.email}</strong></div>
            <div class="order-info">用户ID: ${user.user_id}</div>
            <div class="order-info">注册时间: ${new Date(user.create_time).toLocaleString()}</div>
          </div>
        `).join('');
      } catch (error) {
        console.error('加载用户失败:', error);
        document.getElementById('users-list').innerHTML = '<div class="empty-state">加载用户失败</div>';
      }
    }

    // 加载订单列表
    async function loadOrders() {
      try {
        const { data, error } = await supabase
          .from('orders')
          .select('*')
          .order('create_time', { ascending: false });
        
        const ordersList = document.getElementById('orders-list');
        
        if (error || !data || data.length === 0) {
          ordersList.innerHTML = '<div class="empty-state">暂无订单</div>';
          return;
        }
        
        ordersList.innerHTML = data.map(order => {
          let statusClass = 'status-pending';
          if (order.status === '已支付') statusClass = 'status-paid';
          if (order.status === '已完成') statusClass = 'status-completed';
          
          return `
            <div class="order-item">
              <div class="order-header">
                <div><strong>${order.product}</strong></div>
                <div class="status-badge ${statusClass}">${order.status}</div>
              </div>
              <div class="order-info">用户ID: ${order.user_id}</div>
              <div class="order-info">创建时间: ${new Date(order.create_time).toLocaleString()}</div>
              <div class="order-actions">
                <select onchange="updateOrderStatus(${order.id}, this.value)">
                  <option value="待支付" ${order.status === '待支付' ? 'selected' : ''}>待支付</option>
                  <option value="已支付" ${order.status === '已支付' ? 'selected' : ''}>已支付</option>
                  <option value="已完成" ${order.status === '已完成' ? 'selected' : ''}>已完成</option>
                </select>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('加载订单失败:', error);
        document.getElementById('orders-list').innerHTML = '<div class="empty-state">加载订单失败</div>';
      }
    }

    // 更新订单状态
    async function updateOrderStatus(orderId, status) {
      try {
        await supabase.from('orders').update({ status }).eq('id', orderId);
        loadOrders();
      } catch (error) {
        console.error('更新订单状态失败:', error);
        alert('更新订单状态失败，请重试');
      }
    }

    // 加载数据分析
    async function loadAnalytics() {
      const period = document.getElementById('analytics-period').value;
      const type = document.getElementById('analytics-type').value;
      
      // 这里可以添加更复杂的数据分析逻辑
      // 目前只显示简单的提示
      document.getElementById('analytics-results').innerHTML = `
        <div class="empty-state">
          正在生成 ${period} 天的 ${type} 分析报告...
          <br><br>
          <small>（此功能需要更复杂的数据处理逻辑）</small>
        </div>
      `;
    }

    // 页面加载初始化
    window.onload = () => {
      loadStats();
      loadMessages();
      
      // 每30秒自动刷新统计数据
      setInterval(loadStats, 30000);
    };
  </script>
</body>
          </html>
